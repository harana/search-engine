name: Generate Rust Clients from OpenAPI Specs

on:
  # Run manually
  workflow_dispatch:
    inputs:
      openapi_version:
        description: 'OpenAPI Generator version'
        required: false
        type: string
        default: '7.12.0'
      swagger_version:
        description: 'Swagger Codegen version'
        required: false
        type: string
        default: '3.0.65'
  
  # Run on a schedule (daily at midnight UTC)
  schedule:
    - cron: '0 0 * * *'

env:
  OPENAPI_VERSION: ${{ github.event.inputs.openapi_version || '6.6.0' }}
  SWAGGER_VERSION: ${{ github.event.inputs.swagger_version || '3.0.46' }}

jobs:
  generate-clients:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        client:
          - name: github-api-client
            spec_url: https://raw.githubusercontent.com/github/rest-api-description/main/descriptions/api.github.com/api.github.com.json
            output_dir: clients/github
            generator: openapi
          # Add more clients as needed:
          # - name: another-api-client
          #   spec_url: https://example.com/api-spec.json
          #   output_dir: clients/another
          #   generator: swagger
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Fetch OpenAPI spec
        run: |
          mkdir -p tmp
          curl -o tmp/openapi-spec.json "${{ matrix.client.spec_url }}"
      
      - name: Download Generator CLIs
        run: |
          # Download OpenAPI Generator CLI
          wget https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/${{ env.OPENAPI_VERSION }}/openapi-generator-cli-${{ env.OPENAPI_VERSION }}.jar -O openapi-generator-cli.jar
          
          # Download Swagger Codegen CLI
          wget https://repo1.maven.org/maven2/io/swagger/codegen/v3/swagger-codegen-cli/${{ env.SWAGGER_VERSION }}/swagger-codegen-cli-${{ env.SWAGGER_VERSION }}.jar -O swagger-codegen-cli.jar
      
      - name: Generate Rust client
        run: |
          CLIENT_NAME="${{ matrix.client.name }}"
          OUTPUT_DIR="${{ matrix.client.output_dir }}"
          GENERATOR="${{ matrix.client.generator }}"
          
          # Create the output directory if it doesn't exist
          mkdir -p "$OUTPUT_DIR"
          
          if [ "$GENERATOR" == "openapi" ]; then
            echo "Using OpenAPI Generator for $CLIENT_NAME"
            # Run the OpenAPI Generator
            java -jar openapi-generator-cli.jar generate \
              -i tmp/openapi-spec.json \
              -g rust \
              -o "$OUTPUT_DIR" \
              --additional-properties packageName=$CLIENT_NAME
          elif [ "$GENERATOR" == "swagger" ]; then
            echo "Using Swagger Codegen for $CLIENT_NAME"
            # Run the Swagger Codegen
            java -jar swagger-codegen-cli.jar generate \
              -i tmp/openapi-spec.json \
              -l rust \
              -o "$OUTPUT_DIR" \
              -D packageName=$CLIENT_NAME
          else
            echo "Error: Unknown generator type: $GENERATOR"
            exit 1
          fi
      
      - name: Create branch
        id: create-branch
        run: |
          BRANCH_NAME="feat/update-rust-client-${{ matrix.client.name }}-$(date +'%Y-%m-%d')"
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git checkout -b $BRANCH_NAME
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
      
      - name: Commit changes
        id: commit
        run: |
          # First, clean up any artifacts from the generation process
          rm -f *.jar
          rm -rf tmp
          
          # Check if we have changes in the output directory
          if [ -d "${{ matrix.client.output_dir }}" ]; then
            git add "${{ matrix.client.output_dir }}/"
            
            # Only commit if there are changes
            if ! git diff-index --quiet HEAD --; then
              echo "Changes detected, creating commit"
              git commit -m "Update Rust client for ${{ matrix.client.name }} using ${{ matrix.client.generator }} generator"
              git push origin ${{ steps.create-branch.outputs.branch_name }}
              echo "commit_created=true" >> $GITHUB_OUTPUT
            else
              echo "No changes to commit"
              echo "commit_created=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "Output directory doesn't exist: ${{ matrix.client.output_dir }}"
            echo "commit_created=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Pull Request
        if: steps.commit.outputs.commit_created == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "Update Rust client for ${{ matrix.client.name }}"
          body: |
            This PR updates the Rust client for ${{ matrix.client.name }} based on the latest OpenAPI specification.
            
            - Generated from: ${{ matrix.client.spec_url }}
            - Generated using: ${{ matrix.client.generator == 'openapi' && 'OpenAPI Generator' || 'Swagger Codegen' }}
            - Generator version: ${{ matrix.client.generator == 'openapi' && env.OPENAPI_VERSION || env.SWAGGER_VERSION }}
            - Generated on: $(date +'%Y-%m-%d')
            
            This update was automatically generated by the API Client Generator GitHub Action.
          branch: ${{ steps.create-branch.outputs.branch_name }}
          base: main
          draft: false